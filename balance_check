#!/bin/sh -eu

if test $# -ne 1; then
    echo Usage: $0 BALANCE_CONFIG_JSON >&2
    echo >&2
    echo Reads standard input and outputs Icinga perfdata line >&2
    exit 3
fi

own="`dirname $0`"
tmp=`mktemp`

cat "$own/split_lines.jq" >>$tmp

# Produce limits and put data in
cat <<EOF >>$tmp
    | group_by(.)
    | ( \$conf[0].items | map({key:., value:0})) + map({key:.[0], value: length})
    | from_entries
    | map_values(\$conf[0].item_limits + {value:.})
    + { ratio: (\$conf[0].ratio_limits + {max: 1, value: (map(.) | min / add * length)})}
    |
EOF

# Check limits
cat "$own/inject_state.jq" >>$tmp

# Add msg and exit values based on checked limits
cat <<EOF >>$tmp
    | { msg: ( "connections: " + (del(.ratio) | map(.value) | add | tostring)
             + ", ratio: " + (.ratio.value*100+0.5 | floor/100 | tostring)
             )
      , data: .
      , exit: map(.state) | max
      }
    |
EOF

# Produce Icinga perfdata lines
cat "$own/perfdata.jq" >>$tmp 

jq -Rrsf $tmp --slurpfile conf "$1" | {
    read ret
    cat
    rm $tmp
    exit $ret
}
