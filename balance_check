#!/bin/sh -eu

if test $# -ne 1; then
    echo Usage: $0 BALANCE_CONFIG_JSON >&2
    echo >&2
    echo Reads standard input and outputs Icinga perfdata line >&2
    exit 3
fi

own="`dirname $0`"
tmp=`mktemp`

cat "$own/split_lines.jq" >>$tmp

# Produce limits and put data in
echo '|' >>$tmp
cat "$own/balance_fill.jq" >>$tmp
echo '|' >>$tmp

# Check limits
cat "$own/inject_state.jq" >>$tmp

echo '|' >>$tmp
# Add msg and exit values based on checked limits
cat "$own/msg_and_exit.jq" >>$tmp
echo '|' >>$tmp

# Produce Icinga perfdata lines
cat "$own/perfdata.jq" >>$tmp 

jq -Rrsf $tmp --slurpfile conf "$1" | {
    read ret
    cat
    rm $tmp
    exit $ret
}
